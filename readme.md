<h1 align="center">
<div><img src="https://statechannels.org/favicon.ico"><br>
go-nitro
</h1>

<p align="center">Implementation of the <a href="https://docs.statechannels.org">Nitro State Channels Framework</a> in Golang and Solidity.</p>

`go-nitro` is an implementation of a node in a nitro state channel network. It is software that:

- manages a secret "channel" key
- crafts blockchain transactions (to allow the user to join and exit the network)
- crafts, signs, and sends state channel updates to counterparties in the network
- listens to blockchain events
- listens for counterparty messages
- stores important data to allow for recovery from counterparty inactivity / malice
- understands how to perform these functions safely, without risking any funds

## Usage

> ⚠️ Go-nitro is pre-production software ⚠️

Go-nitro can be consumed either as [library code](./node/readme.md) or run as an [independent process](./doc.go) and interfaced with remote procedure calls (recommended).

## Contributing

Please see [contributing.md](./contributing.md)

## ADRs

Architectural decision records may be viewed [here](./.adr/0000-adrs.md).

## Testing

> Pre-requisite: [generate a TLS certificate](./tls/readme.md)

Run the tests from repo root:

```
go test ./... -count=2 -shuffle=on -timeout 1m -v -failfast
```

## On-chain code

The on-chain component of Nitro (i.e. the solidity contracts) are housed in the [`nitro-protocol`](./packages/nitro-protocol/readme.md) directory. This directory contains an yarn workspace with a hardhat / typechain / jest toolchain.

## Steps to perform payments between two go-nitro nodes

- Follow this [doc](https://book.getfoundry.sh/getting-started/installation) to set up foundry to run anvil chain.

- Start anvil chain:

    ```bash
    anvil  --chain-id 1337 --block-time 1
    ```

- Deploy the Nitro protocol contracts:

    ```bash
    # In packages/nitro-protocol
    yarn contracts:deploy-localhost
    ```

    Note: On restarting the chain, make sure to remove `packages/nitro-protocol/hardhat-deployments` when redeploying contracts.

    ```bash
    rm -rf hardhat-deployments
    ```

- Generate tls certificate following [README](tls/readme.md)

- Run go-nitro node for Alice:

    ```bash
    export NITRO_CHAIN_URL=ws://127.0.0.1:8545
    export ALICE_ADDRESS=0xAAA6628Ec44A8a742987EF3A114dDFE2D4F7aDCE
    export ALICE_PK=2d999770f7b5d49b694080f987b82bbc9fc9ac2b4dcc10b0f8aba7d700f69c6d
    export ALICE_CHAIN_PK=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
    export NA_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
    export VPA_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
    export CA_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0

    go run . -chainurl ${NITRO_CHAIN_URL} -msgport 3006 -rpcport 4006 -pk $ALICE_PK -chainpk $ALICE_CHAIN_PK -naaddress $NA_ADDRESS -vpaaddress $VPA_ADDRESS -caaddress $CA_ADDRESS -tlskeyfilepath ./tls/statechannels.org_key.pem -tlscertfilepath ./tls/statechannels.org.pem
    ```

- Run go-nitro node for Bob:

    ```bash
    export NITRO_CHAIN_URL=ws://127.0.0.1:8545
    export BOB_ADDRESS=0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94
    export BOB_PK=0279651921cd800ac560c21ceea27aab0107b67daf436cdd25ce84cad30159b4
    export BOB_CHAIN_PK=59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
    export NA_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
    export VPA_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
    export CA_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0

    go run . -chainurl ${NITRO_CHAIN_URL} -msgport 3007 -rpcport 4007 -pk $BOB_PK -chainpk $BOB_CHAIN_PK -naaddress $NA_ADDRESS -vpaaddress $VPA_ADDRESS -caaddress $CA_ADDRESS  -bootpeers "/ip4/10.18.121.160/tcp/3006/p2p/16Uiu2HAmSjXJqsyBJgcBUU2HQmykxGseafSatbpq5471XmuaUqyv" -tlskeyfilepath ./tls/statechannels.org_key.pem -tlscertfilepath ./tls/statechannels.org.pem
    ```

  - Provide Alice's P2P multiaddr as a bootpeer to Bob.

- Change directory to `packages/nitro-rpc-client`

- Set `NODE_EXTRA_CA_CERTS` environment variable to the path of a root certificate file (rootCA.pem) generated by mkcert

    ```bash
    export NODE_EXTRA_CA_CERTS="$(mkcert -CAROOT)/rootCA.pem"
    ```

- Create a ledger channel:

    ```bash
    npm exec -c 'nitro-rpc-client direct-fund 0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94 -p 4006'
    ```

- Create a virtual payment channel:

    ```bash
    npm exec -c 'nitro-rpc-client virtual-fund 0xBBB676f9cFF8D242e9eaC39D063848807d3D1D94 -p 4006'
    ```

- Make payment from Alice to Bob:

    ```bash
    npm exec -c 'nitro-rpc-client pay 0x66dc9aa194707f302de6d1d386a54f8ee82d47f5ba6a3e66176273741d8860e2 50 -p 4006'
    ```

- Close the virtual payment channel:

    ```bash
    npm exec -c 'nitro-rpc-client virtual-defund 0x66dc9aa194707f302de6d1d386a54f8ee82d47f5ba6a3e66176273741d8860e2 -p 4006'
    ```

- Close the ledger channel:

    ```bash
    npm exec -c 'nitro-rpc-client direct-defund 0x9502f6310933a3f56b43d51e2ecbab0926bd6db98a4e636004de66f2028527f5 -p 4006'
    ```

## License

Dual-licensed under [MIT](https://opensource.org/licenses/MIT) + [Apache 2.0](http://www.apache.org/licenses/LICENSE-2.0)
